<!DOCTYPE html>
<html lang="en">
<head>
  <title>ShopMore</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="bootstrap/js/bootstrap.min.js"></script>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <a class="navbar-brand" href="#">ShopMore</a>
  <div class="collapse navbar-collapse navbar-right" id="navbarNav">
    <ul class="navbar-nav ml-auto" id="user_info_nav_group">
      <li>
        <button class="btn btn-outline-success mr-sm-2" data-toggle="modal" data-target="#login_modal">Login</button>
      </li>
      <li>
        <button class="btn btn-outline-success" data-toggle="modal" data-target="#register_modal">Register</button>
      </li>
      <li class="dropdown-down dropdown-menu-right ml-sm-2 d-none">
        <button class="btn btn-outline-success dropdown-toggle" id="user_info_facade" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          User
        </button>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="user_info_dropdown">
          <span class="dropdown-item" id="logout">Logout</span>
          <span class="dropdown-item" id="change_password">Change Password</span>
          <span class="dropdown-item">Something else here</span>
        </div>
      </li>
    </ul>
  </div>
</nav>


<!-- LOGIN Modal -->
<div class="modal fade" id="login_modal" >
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">User Login</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="login_form">
          <div class="form-group">
            <label for="login_user_email_address">Email address</label>
            <input type="email" name="email" class="form-control" id="login_user_email_address" placeholder="Enter email">
          </div>
          <div class="form-group">
            <label for="login_user_password">Password</label>
            <input type="password" name = "pw" class="form-control" id="login_user_password" placeholder="Password">
          </div>
          <button id = "btn_login" type="button" class="btn btn-primary">Submit</button>
          <button id="btn_reset" type="button" class="btn btn-warning">Reset Password</button>
        </form>
        <div class="alert alert-primary d-none mt-sm-4" role="alert" id="login_resp"></div>
      </div>
      </div>
    </div>
  </div>
</div>

<!-- REGISTER Modal -->
<div class="modal fade" id="register_modal" >
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">User Register</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="register_form">
          <div class="form-group">
            <label for="user_first_name">Email address</label>
            <input type="text" name="user_first_name" class="form-control" id="user_first_name" placeholder="First Name">
          </div>
          <div class="form-group">
            <label for="user_last_name">Email address</label>
            <input type="text" name="user_last_name" class="form-control" id="user_last_name" placeholder="Last Name">
          </div>
          <div class="form-group">
            <label for="reg_user_email_address">Email address</label>
            <input type="email" name="email" class="form-control" id="reg_user_email_address" placeholder="Email">
          </div>
          <div class="form-group">
            <label for="reg_user_password">Password</label>
            <input type="password" name = "pw" class="form-control" id="reg_user_password" placeholder="Password">
          </div>
          <button id = "btn_register" type="button" class="btn btn-primary">Submit</button>
          <div class="alert alert-primary d-none mt-sm-4" role="alert" id="register_resp"></div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Forgot Password Modal -->
<div class="modal fade" id="pass_reset_modal" >
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Reset Passoword</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="pass_reset_form">
          <div class="form-group">
            <label for="user_email">Email address</label>
            <input type="text" name="user_email" class="form-control" id="user_email">
          </div>
          <button id = "btn_pass_reset" type="button" class="btn btn-primary">Submit</button>
        </form>
        <div id="reset_req_result" class="mt-sm-2 d-none alert alert-primary" role="alert"></div>
      </div>
    </div>
  </div>
</div>

<div id="catalog_stuff">
  <a href="/catalog">Shop All Categories</a>
  |
  <a href="/categories">Shop By Category</a>
</div>

<!-- Profile details from customer -->
<div id="profile_info" >
  <center>
    <br />
    <div id="profile_info_uid">User ID: </div>
    <div id="profile_info_name">Name: </div>
    <div id="profile_info_email">Email: </div>
  </center>
</div>

<!-- Profile details from order -->
<div id="orders_info" >
  <center>
    <br />
    <h4>Orders</h4>
    <br />
    <ul id="orders_order">No Available Orders</ul>
  </center>
</div>

<script type="text/javascript">

  function createCookie(name,value,days) {
    if (days) {
      var date = new Date();
      date.setTime(date.getTime()+(days*24*60*60*1000));
      var expires = "; expires="+date.toGMTString();
    }
    else var expires = "";
    document.cookie = name+"="+value+expires+"; path=/";
  }

  function readCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i=0;i < ca.length;i++) {
      var c = ca[i];
      while (c.charAt(0)==' ') c = c.substring(1,c.length);
      if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
  }

  function eraseCookie(name) {
    createCookie(name,"",-1);
  }

  function setUser(user) {
    $('#user_info_facade').html(user.firstName + " " + user.lastName);
    $('#user_info_nav_group li:nth-child(3)').removeClass('d-none');
    $('#user_info_nav_group li:lt(2)').addClass("d-none");
  }

  function getProfileOrders(usid) {
    var my_url = window.location.href.split("/");
    var profile_id = my_url[my_url.length - 1];

    if (!usid) {
            usid = 'null';
    }

    var link = '/customers/' + profile_id;
    $.get(link)
      .done(function(resp) {
         $('#profile_info_uid').html("User ID: " + resp.id);
         $('#profile_info_name').html("Name: " + resp.firstName + " " + resp.lastName);
         $('#profile_info_email').html("Email: " + resp.email);
    });

    var link2 = '/orders/' + profile_id;
    var link3 = '';
    $.get(link2)
      .done(function(resp) {
         console.log(resp);
         var lis = '';
         for (var itme in resp) {
                 let itm = resp[itme]
                 console.log(itm);
                 var firstprod = itm.items[0];
                 //link3 = '/products/' + firstprod;
                 lis += "<li>";
                 lis += "Order ID: " + itm.id;
                 lis += "<br />" + "Order Date: " + itm.created;
                 //lis += "<br />" + "Items include: <br />" //+ "pictures to be added..."
                 /*$.get(link3).done(function(respo) {
                         console.log(respo);
                         lis += "<a href=\"" + respo.img_url + "\"></a>"
                 })*/
                 lis += "</li>";
         }
         $('#orders_order').html(lis);
         //@TODO: when we have products working, get each product by ID
         //so we can display the images/names
    });
  }

  $('#login_modal #btn_login').click(function() {
    $.post('/login', $('#login_form').serialize())
    .done(function(response) {
      if(response.msg == "LoggedIn") {
        var link = response.links[0].href;

        $.get(link)
        .done(function(user) {
          setUser(user);
          $('#login_modal').modal('toggle');
          createCookie("user_id", user.id);
        });
      }
    })
    .fail(function() {
      $('#login_resp').removeClass('d-none').html("Forbidden: Invalid credentials");
    });
  });


  $("#register_modal #btn_register").click(function() {
    $.post('/register', $('#register_form').serialize())
    .done(function(response) {
      $('#register_resp')
      .removeClass('d-none')
      .html('Activate your account using link sent to your registered email');
    });
  });
  $('#login_modal #btn_reset').click(function() {
    $('#login_modal').modal('toggle');
    $('#pass_reset_modal').modal('toggle');
  });

  $('#btn_pass_reset').click(function() {
    $.post('/passresetreq', $('#pass_reset_form').serialize())
    .done(function(resp) {
      $('#reset_req_result').removeClass('d-none');
      $('#reset_req_result').html(resp);
    });
  });

  $('#change_password').click(function(){
    $('#pass_reset_modal').modal('toggle');
    var cookie_user_id = readCookie('user_id');
    var link = '/customers/' + cookie_user_id;
    $.get(link)
    .done(function(resp) {
      $('#pass_reset_modal #user_email').val(resp.email);
    })
  });

  $('#logout').click(function(){
    eraseCookie("user_id");
    $('#user_info_nav_group li:nth-child(3)').addClass('d-none');
    $('#user_info_nav_group li:lt(2)').removeClass("d-none");
  });

  $(document).ready(function(){
    var cookie_user_id = readCookie("user_id");
    if(cookie_user_id) {
      // a user is already logged in
      $.get("/customers/" + cookie_user_id)
      .done(function(user) {
        setUser(user);

        // remind the user that his/her accout needs activation
        if(user.status == "PENDING") {
          alert('Please activate your account');
        }
      });
    }
    getProfileOrders(cookie_user_id);
  });
</script>


</body>
</html>
